# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: iOS Swift Code Review with Claude

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.swift'
      - '**/*.h'
      - '**/*.m'

jobs:
  code-review:
    if: false 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **/*.swift
          **/*.h
          **/*.m
        separator: ","
    
    - name: Code Review with Claude
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Changed files
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',');
          
          // ì½”ë“œë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ëŠ” í•¨ìˆ˜
          function chunkCode(code, maxChunkSize = 8000) {
            const lines = code.split('\n');
            const chunks = [];
            let currentChunk = '';
            
            for (const line of lines) {
              if ((currentChunk + line + '\n').length > maxChunkSize && currentChunk.length > 0) {
                chunks.push(currentChunk.trim());
                currentChunk = line + '\n';
              } else {
                currentChunk += line + '\n';
              }
            }
            
            if (currentChunk.trim().length > 0) {
              chunks.push(currentChunk.trim());
            }
            
            return chunks;
          }

          // Anthropic API í˜¸ì¶œ í•¨ìˆ˜
          async function reviewCodeWithClaude(code, filename, chunkIndex = null) {
            const chunkInfo = chunkIndex !== null ? ` (Part ${chunkIndex + 1})` : '';
            const prompt = `
          ë‹¤ìŒì€ iOS Swift í”„ë¡œì íŠ¸ì˜ ì½”ë“œ${chunkInfo}ìž…ë‹ˆë‹¤. ê°„ê²°í•˜ê³  í•µì‹¬ì ì¸ ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì£¼ì„¸ìš”:

          íŒŒì¼: ${filename}${chunkInfo}
          
          \`\`\`swift
          ${code}
          \`\`\`

          ë‹¤ìŒ ê´€ì ì—ì„œ **ì¤‘ìš”í•œ ì´ìŠˆë§Œ** ê°„ë‹¨ížˆ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
          1. **ë©”ëª¨ë¦¬ ê´€ë¦¬**: ê°•í•œ ì°¸ì¡° ì‚¬ì´í´, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
          2. **ì„±ëŠ¥**: ëª…í™•í•œ ì„±ëŠ¥ ë¬¸ì œ
          3. **ë²„ê·¸**: ëŸ°íƒ€ìž„ ì—ëŸ¬ë‚˜ ë¡œì§ ì˜¤ë¥˜
          4. **ë³´ì•ˆ**: ë°ì´í„° ë…¸ì¶œì´ë‚˜ ë³´ì•ˆ ì·¨ì•½ì 
          5. **Swift ì»¨ë²¤ì…˜**: ì¤‘ìš”í•œ ìŠ¤íƒ€ì¼ ìœ„ë°˜

          ### ì‘ë‹µ í˜•ì‹ (ê°„ê²°í•˜ê²Œ):
          - âœ… **ìž˜ëœ ì ** (1-2ì¤„)
          - âš ï¸ **ì£¼ìš” ì´ìŠˆ** (êµ¬ì²´ì  ë¬¸ì œì ë§Œ)
          - ðŸ’¡ **ê°œì„  ì œì•ˆ** (í•µì‹¬ ê°œì„ ì‚¬í•­ë§Œ)

          ë¶ˆí•„ìš”í•œ ì„¤ëª…ì€ ìƒëžµí•˜ê³  í•µì‹¬ë§Œ ê°„ë‹¨ížˆ ìž‘ì„±í•´ì£¼ì„¸ìš”.
            `;

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-sonnet-4-20250514',  // ìµœì‹  Claude Sonnet 4 ëª¨ë¸
                  max_tokens: 4000,  // í† í° ìˆ˜ ìµœì í™”
                  messages: [{
                    role: 'user',
                    content: prompt
                  }]
                })
              });

              if (!response.ok) {
                throw new Error(`API responded with status ${response.status}`);
              }

              const data = await response.json();
              return data.content[0].text;
            } catch (error) {
              console.error('Claude API Error:', error);
              return `âš ï¸ ì½”ë“œ ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            }
          }

          // ê° ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•´ ë¦¬ë·° ìˆ˜í–‰
          let reviewComments = [];
          
          for (const file of changedFiles) {
            if (file.endsWith('.swift') || file.endsWith('.h') || file.endsWith('.m')) {
              try {
                const fileContent = fs.readFileSync(file, 'utf8');
                
                // íŒŒì¼ í¬ê¸° ì²´í¬ - 15,000ìžë¡œ ì œí•œ
                if (fileContent.length > 15000) {
                  reviewComments.push(`
          ## ðŸ“ ${file}
          
          âš ï¸ **íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤** (${Math.round(fileContent.length/1000)}k characters)
          - íŒŒì¼ì„ ë” ìž‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ë¥¼ ê³ ë ¤í•´ë³´ì„¸ìš”
          - ì½”ë“œ ë¦¬ë·°ë¥¼ ìœ„í•´ íŒŒì¼ì„ ë‚˜ëˆ„ì–´ ë‹¤ì‹œ PR í•´ì£¼ì„¸ìš”
                  `);
                  continue;
                }
                
                console.log(`Reviewing file: ${file} (${fileContent.length} chars)`);
                
                // í° íŒŒì¼ì€ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬
                if (fileContent.length > 8000) {
                  const chunks = chunkCode(fileContent);
                  let chunkReviews = [];
                  
                  for (let i = 0; i < Math.min(chunks.length, 3); i++) { // ìµœëŒ€ 3ê°œ ì²­í¬ë§Œ ì²˜ë¦¬
                    const review = await reviewCodeWithClaude(chunks[i], file, i);
                    chunkReviews.push(review);
                    
                    // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ
                    if (i < chunks.length - 1) {
                      await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                  }
                  
                  reviewComments.push(`
          ## ðŸ“ ${file}
          
          ${chunkReviews.join('\n\n---\n\n')}
          
          ${chunks.length > 3 ? `\nâš ï¸ **íŒŒì¼ì´ ì»¤ì„œ ì²˜ìŒ 3ê°œ ì„¹ì…˜ë§Œ ë¦¬ë·°í–ˆìŠµë‹ˆë‹¤**` : ''}
                  `);
                } else {
                  // ìž‘ì€ íŒŒì¼ì€ ì „ì²´ ë¦¬ë·°
                  const review = await reviewCodeWithClaude(fileContent, file);
                  reviewComments.push(`
          ## ðŸ“ ${file}
          
          ${review}
                  `);
                }
                
                // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.error(`Error processing file ${file}:`, error);
                reviewComments.push(`
          ## ðŸ“ ${file}
          
          âš ï¸ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}
                `);
              }
            }
          }

          // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
          if (reviewComments.length > 0) {
            const fullReview = `
          # ðŸ¤– Claude iOS Code Review
          
          > Claude Sonnet 4 AI ìžë™ ë¦¬ë·° (í•µì‹¬ ì´ìŠˆ ì¤‘ì‹¬)
          
          ${reviewComments.join('\n\n---\n\n')}
          
          ---
          
          ### ðŸ“ ì°¸ê³ :
          - AI ë¦¬ë·°ì´ë¯€ë¡œ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©
          - ì¤‘ìš”í•œ ë³€ê²½ì‚¬í•­ì€ íŒ€ ë¦¬ë·° í•„ìˆ˜
          - ë³´ì•ˆ ì´ìŠˆëŠ” ë³„ë„ ê²€í†  í•„ìš”
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fullReview
            });
          }

    - name: Swift Lint (Optional)
      run: |
        if command -v swiftlint &> /dev/null; then
          swiftlint --reporter github-actions-logging
        else
          echo "SwiftLint not found, skipping..."
        fi
