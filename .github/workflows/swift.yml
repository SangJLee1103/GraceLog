# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: iOS Swift Code Review with Claude

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**/*.swift'
      - '**/*.h'
      - '**/*.m'

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **/*.swift
          **/*.h
          **/*.m
        separator: ","
    
    - name: Code Review with Claude
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        github-token: ${{ secrets.GIT_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Changed files
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',');
          
          // Anthropic API í˜¸ì¶œ í•¨ìˆ˜
          async function reviewCodeWithClaude(code, filename) {
            const prompt = `
          ë‹¤ìŒì€ iOS Swift í”„ë¡œì íŠ¸ì˜ ì½”ë“œìž…ë‹ˆë‹¤. ì „ë¬¸ì ì¸ ì½”ë“œ ë¦¬ë·°ë¥¼ í•´ì£¼ì„¸ìš”:

          íŒŒì¼: ${filename}
          
          \`\`\`swift
          ${code}
          \`\`\`

          ë‹¤ìŒ ê´€ì ì—ì„œ ë¦¬ë·°í•´ì£¼ì„¸ìš”:
          1. **ì•„í‚¤í…ì²˜ íŒ¨í„´**: MVVM, Coordinator, ReactorKit ë“±ì˜ ì ì ˆí•œ ì‚¬ìš©
          2. **ë©”ëª¨ë¦¬ ê´€ë¦¬**: ê°•í•œ ì°¸ì¡° ì‚¬ì´í´, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°€ëŠ¥ì„±
          3. **ì„±ëŠ¥**: ë¹„íš¨ìœ¨ì ì¸ ì½”ë“œë‚˜ ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„
          4. **ì½”ë“œ í’ˆì§ˆ**: ê°€ë…ì„±, ìœ ì§€ë³´ìˆ˜ì„±, Swift ì»¨ë²¤ì…˜
          5. **ë³´ì•ˆ**: ìž ìž¬ì  ë³´ì•ˆ ì´ìŠˆ
          6. **ë² ìŠ¤íŠ¸ í”„ëž™í‹°ìŠ¤**: iOS ê°œë°œ ëª¨ë²” ì‚¬ë¡€ ì¤€ìˆ˜

          ### ë¦¬ë·° í˜•ì‹:
          - âœ… **ìž˜ëœ ì **: ì¢‹ì€ ë¶€ë¶„ë“¤
          - âš ï¸ **ê°œì„  í•„ìš”**: ë¬¸ì œì ê³¼ í•´ê²° ë°©ì•ˆ
          - ðŸ’¡ **ì œì•ˆì‚¬í•­**: ë” ë‚˜ì€ êµ¬í˜„ ë°©ë²•
          - ðŸ› **ìž ìž¬ì  ë²„ê·¸**: ë°œê²¬ëœ ë¬¸ì œì 

          êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
            `;

            try {
              const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                  model: 'claude-3-sonnet-20240229',
                  max_tokens: 4000,
                  messages: [{
                    role: 'user',
                    content: prompt
                  }]
                })
              });

              const data = await response.json();
              return data.content[0].text;
            } catch (error) {
              console.error('Claude API Error:', error);
              return `âš ï¸ ì½”ë“œ ë¦¬ë·° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            }
          }

          // ê° ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•´ ë¦¬ë·° ìˆ˜í–‰
          let reviewComments = [];
          
          for (const file of changedFiles) {
            if (file.endsWith('.swift') || file.endsWith('.h') || file.endsWith('.m')) {
              try {
                const fileContent = fs.readFileSync(file, 'utf8');
                
                // íŒŒì¼ì´ ë„ˆë¬´ í¬ë©´ ìŠ¤í‚µ (Claude í† í° ì œí•œ)
                if (fileContent.length > 10000) {
                  reviewComments.push(`
          ## ðŸ“ ${file}
          
          âš ï¸ **íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤** (${fileContent.length} characters)
          - íŒŒì¼ì„ ë” ìž‘ì€ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”
          - ë‹¨ì¼ ì±…ìž„ ì›ì¹™(SRP)ì„ ì ìš©í•´ë³´ì„¸ìš”
                  `);
                  continue;
                }
                
                console.log(`Reviewing file: ${file}`);
                const review = await reviewCodeWithClaude(fileContent, file);
                
                reviewComments.push(`
          ## ðŸ“ ${file}
          
          ${review}
                `);
                
                // API í˜¸ì¶œ ê°„ê²© ì¡°ì ˆ (rate limiting ë°©ì§€)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
              } catch (error) {
                console.error(`Error processing file ${file}:`, error);
                reviewComments.push(`
          ## ðŸ“ ${file}
          
          âš ï¸ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}
                `);
              }
            }
          }

          // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
          if (reviewComments.length > 0) {
            const fullReview = `
          # ðŸ¤– Claude iOS Swift Code Review
          
          > ì´ ë¦¬ë·°ëŠ” Claude AIì— ì˜í•´ ìžë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ${reviewComments.join('\n\n---\n\n')}
          
          ---
          
          ### ðŸ“ ì°¸ê³ ì‚¬í•­:
          - ì´ ë¦¬ë·°ëŠ” AIê°€ ìƒì„±í•œ ê²ƒìœ¼ë¡œ, ì°¸ê³ ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•´ì£¼ì„¸ìš”
          - ì¤‘ìš”í•œ ë³€ê²½ì‚¬í•­ì€ íŒ€ì›ê³¼ í•¨ê»˜ ê²€í† í•´ì£¼ì„¸ìš”
          - ë³´ì•ˆ ê´€ë ¨ ì´ìŠˆëŠ” ë³„ë„ë¡œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: fullReview
            });
          }

    - name: Swift Lint (Optional)
      run: |
        if command -v swiftlint &> /dev/null; then
          swiftlint --reporter github-actions-logging
        else
          echo "SwiftLint not found, skipping..."
        fi
